---
title: ç±»å‹
sidebar:
  order: 2
---

import { FileTree, Aside } from '@astrojs/starlight/components';

æœ¬æŒ‡å—æ¶‰åŠæ¥è‡ªç±»å‹åŒ–è¯­è¨€ï¼ˆå¦‚ TypeScriptï¼‰çš„æ•°æ®ç±»å‹ï¼Œå¹¶æè¿°å®ƒä»¬åœ¨ FSD ä¸­çš„é€‚ç”¨ä½ç½®ã€‚

<Aside>

æœ¬æŒ‡å—æ²¡æœ‰æ¶µç›–æ‚¨çš„é—®é¢˜ï¼Ÿè¯·é€šè¿‡åœ¨æœ¬æ–‡ä¸Šç•™ä¸‹åé¦ˆï¼ˆå³ä¾§çš„è“è‰²æŒ‰é’®ï¼‰æ¥å‘å¸ƒæ‚¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°†è€ƒè™‘æ‰©å±•æœ¬æŒ‡å—ï¼

</Aside>

## å®ç”¨ç±»å‹

å®ç”¨ç±»å‹æ˜¯æœ¬èº«æ²¡æœ‰å¤ªå¤šæ„ä¹‰çš„ç±»å‹ï¼Œé€šå¸¸ä¸å…¶ä»–ç±»å‹ä¸€èµ·ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼š

<figure>

```ts
type ArrayValues<T extends readonly unknown[]> = T[number];
```

<figcaption>
  Source: https://github.com/sindresorhus/type-fest/blob/main/source/array-values.d.ts
</figcaption>

</figure>

è¦ä½¿å®ç”¨ç±»å‹åœ¨æ•´ä¸ªé¡¹ç›®ä¸­å¯ç”¨ï¼Œå¯ä»¥å®‰è£…åƒ [`type-fest`][ext-type-fest] è¿™æ ·çš„åº“ï¼Œæˆ–è€…åœ¨ `shared/lib` ä¸­åˆ›å»ºæ‚¨è‡ªå·±çš„åº“ã€‚ç¡®ä¿æ¸…æ¥šåœ°æŒ‡å‡ºå“ªäº›æ–°ç±»å‹_åº”è¯¥_æ·»åŠ åˆ°æ­¤åº“ä¸­ï¼Œå“ªäº›ç±»å‹_ä¸å±äº_é‚£é‡Œã€‚ä¾‹å¦‚ï¼Œå°†å…¶å‘½åä¸º `shared/lib/utility-types` å¹¶åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ª READMEï¼Œæè¿°æ‚¨å›¢é˜Ÿä¸­ä»€ä¹ˆæ˜¯å®ç”¨ç±»å‹ã€‚

ä¸è¦é«˜ä¼°å®ç”¨ç±»å‹çš„æ½œåœ¨å¯é‡ç”¨æ€§ã€‚ä»…ä»…å› ä¸ºå®ƒå¯ä»¥è¢«é‡ç”¨ï¼Œå¹¶ä¸æ„å‘³ç€å®ƒä¼šè¢«é‡ç”¨ï¼Œå› æ­¤ï¼Œå¹¶éæ¯ä¸ªå®ç”¨ç±»å‹éƒ½éœ€è¦åœ¨ Shared ä¸­ã€‚ä¸€äº›å®ç”¨ç±»å‹æ”¾åœ¨éœ€è¦å®ƒä»¬çš„åœ°æ–¹å°±å¾ˆå¥½ï¼š

<FileTree>
- pages/
  - home/
    - api/
      - ArrayValues.ts utility type
      - getMemoryUsageMetrics.ts uses the utility type
</FileTree>

<Aside type="caution">

æŠµåˆ¶åˆ›å»º `shared/types` æ–‡ä»¶å¤¹æˆ–å‘æ‚¨çš„ slices æ·»åŠ  `types` segment çš„è¯±æƒ‘ã€‚"types"ç±»åˆ«ç±»ä¼¼äº"components"æˆ–"hooks"ç±»åˆ«ï¼Œå®ƒæè¿°çš„æ˜¯å†…å®¹æ˜¯ä»€ä¹ˆï¼Œè€Œä¸æ˜¯å®ƒä»¬çš„ç”¨é€”ã€‚Segments åº”è¯¥æè¿°ä»£ç çš„ç›®çš„ï¼Œè€Œä¸æ˜¯æœ¬è´¨ã€‚

</Aside>

## ä¸šåŠ¡å®ä½“åŠå…¶äº¤å‰å¼•ç”¨ \{#business-entities-and-their-cross-references}

åº”ç”¨ç¨‹åºä¸­æœ€é‡è¦çš„ç±»å‹ä¹‹ä¸€æ˜¯ä¸šåŠ¡å®ä½“çš„ç±»å‹ï¼Œå³æ‚¨çš„åº”ç”¨ç¨‹åºå¤„ç†çš„ç°å®ä¸–ç•Œçš„äº‹ç‰©ã€‚ä¾‹å¦‚ï¼Œåœ¨éŸ³ä¹æµåª’ä½“åº”ç”¨ç¨‹åºä¸­ï¼Œæ‚¨å¯èƒ½æœ‰ä¸šåŠ¡å®ä½“ _Song_ã€_Album_ ç­‰ã€‚

ä¸šåŠ¡å®ä½“é€šå¸¸æ¥è‡ªåç«¯ï¼Œå› æ­¤ç¬¬ä¸€æ­¥æ˜¯ä¸ºåç«¯å“åº”æ·»åŠ ç±»å‹ã€‚ä¸ºæ¯ä¸ªç«¯ç‚¹åˆ›å»ºä¸€ä¸ªè¯·æ±‚å‡½æ•°ï¼Œå¹¶ä¸ºæ­¤å‡½æ•°çš„å“åº”æ·»åŠ ç±»å‹æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ä¸ºäº†é¢å¤–çš„ç±»å‹å®‰å…¨ï¼Œæ‚¨å¯èƒ½å¸Œæœ›é€šè¿‡åƒ [Zod][ext-zod] è¿™æ ·çš„ schema éªŒè¯åº“æ¥è¿è¡Œå“åº”ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å°†æ‰€æœ‰è¯·æ±‚ä¿å­˜åœ¨ Shared ä¸­ï¼Œæ‚¨å¯ä»¥è¿™æ ·åšï¼š

```ts title="shared/api/songs.ts"
import type { Artist } from "./artists";

interface Song {
  id: number;
  title: string;
  artists: Array<Artist>;
}

export function listSongs() {
  return fetch('/api/songs').then((res) => res.json() as Promise<Array<Song>>);
}
```

æ‚¨å¯èƒ½ä¼šæ³¨æ„åˆ° `Song` ç±»å‹å¼•ç”¨äº†ä¸åŒçš„å®ä½“ `Artist`ã€‚è¿™æ˜¯å°†è¯·æ±‚å­˜å‚¨åœ¨ Shared ä¸­çš„å¥½å¤„ â€” ç°å®ä¸–ç•Œçš„ç±»å‹é€šå¸¸æ˜¯ç›¸äº’äº¤ç»‡çš„ã€‚å¦‚æœæˆ‘ä»¬å°†æ­¤å‡½æ•°ä¿å­˜åœ¨ `entities/song/api` ä¸­ï¼Œæˆ‘ä»¬å°†æ— æ³•ç®€å•åœ°ä» `entities/artist` å¯¼å…¥ `Artist`ï¼Œå› ä¸º FSD é€šè¿‡[å±‚ä¸Šçš„å¯¼å…¥è§„åˆ™][import-rule-on-layers]é™åˆ¶ slices ä¹‹é—´çš„äº¤å‰å¯¼å…¥ï¼š

> slice ä¸­çš„æ¨¡å—åªèƒ½åœ¨å…¶ä»– slices ä½äºä¸¥æ ¼è¾ƒä½çš„å±‚æ—¶å¯¼å…¥å®ƒä»¬ã€‚

æœ‰ä¸¤ç§æ–¹æ³•æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ï¼š

1. **å‚æ•°åŒ–æ‚¨çš„ç±»å‹**
   æ‚¨å¯ä»¥è®©æ‚¨çš„ç±»å‹æ¥å—ç±»å‹å‚æ•°ä½œä¸ºä¸å…¶ä»–å®ä½“è¿æ¥çš„æ’æ§½ï¼Œç”šè‡³å¯ä»¥å¯¹è¿™äº›æ’æ§½æ–½åŠ çº¦æŸã€‚ä¾‹å¦‚ï¼š

   ```ts title="entities/song/model/song.ts"
   interface Song<ArtistType extends { id: string }> {
     id: number;
     title: string;
     artists: Array<ArtistType>;
   }
   ```

   è¿™å¯¹æŸäº›ç±»å‹æ¯”å…¶ä»–ç±»å‹æ•ˆæœæ›´å¥½ã€‚åƒ `Cart = { items: Array<Product> }` è¿™æ ·çš„ç®€å•ç±»å‹å¯ä»¥å¾ˆå®¹æ˜“åœ°ä¸ä»»ä½•ç±»å‹çš„äº§å“ä¸€èµ·å·¥ä½œã€‚æ›´è¿æ¥çš„ç±»å‹ï¼Œå¦‚ `Country` å’Œ `City`ï¼Œå¯èƒ½ä¸é‚£ä¹ˆå®¹æ˜“åˆ†ç¦»ã€‚

2. **äº¤å‰å¯¼å…¥ï¼ˆä½†è¦æ­£ç¡®åœ°åšï¼‰**
   è¦åœ¨ FSD ä¸­çš„å®ä½“ä¹‹é—´è¿›è¡Œäº¤å‰å¯¼å…¥ï¼Œæ‚¨å¯ä»¥ä¸ºæ¯ä¸ªå°†è¦äº¤å‰å¯¼å…¥çš„ slice ä½¿ç”¨ç‰¹æ®Šçš„å…¬å…± APIã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰å®ä½“ `song`ã€`artist` å’Œ `playlist`ï¼Œåä¸¤è€…éœ€è¦å¼•ç”¨ `song`ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ `song` å®ä½“ä¸­ä½¿ç”¨ `@x` ç¬¦å·ä¸ºå®ƒä»¬åˆ›å»ºä¸¤ä¸ªç‰¹æ®Šçš„å…¬å…± APIï¼š

   <FileTree>
   - entities/
     - song/
       - @x/
         - artist.ts ä¾› `artist` å®ä½“å¯¼å…¥çš„å…¬å…± API
         - playlist.ts ä¾› `playlist` å®ä½“å¯¼å…¥çš„å…¬å…± API
       - index.ts å¸¸è§„å…¬å…± API
   </FileTree>

   æ–‡ä»¶ `ğŸ“„ entities/song/@x/artist.ts` çš„å†…å®¹ç±»ä¼¼äº `ğŸ“„ entities/song/index.ts`ï¼š

   ```ts title="entities/song/@x/artist.ts"
   export type { Song } from "../model/song.ts";
   ```

   ç„¶å `ğŸ“„ entities/artist/model/artist.ts` å¯ä»¥åƒè¿™æ ·å¯¼å…¥ `Song`ï¼š

   ```ts title="entities/artist/model/artist.ts"
   import type { Song } from "entities/song/@x/artist";

   export interface Artist {
     name: string;
     songs: Array<Song>;
   }
   ```

   é€šè¿‡åœ¨å®ä½“ä¹‹é—´å»ºç«‹æ˜¾å¼è¿æ¥ï¼Œæˆ‘ä»¬æŒæ¡ç›¸äº’ä¾èµ–å…³ç³»å¹¶ä¿æŒè‰¯å¥½çš„åŸŸåˆ†ç¦»æ°´å¹³ã€‚

## æ•°æ®ä¼ è¾“å¯¹è±¡å’Œæ˜ å°„å™¨ \{#data-transfer-objects-and-mappers}

æ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œæˆ– DTOï¼Œæ˜¯ä¸€ä¸ªæè¿°æ¥è‡ªåç«¯çš„æ•°æ®å½¢çŠ¶çš„æœ¯è¯­ã€‚æœ‰æ—¶ï¼ŒDTO å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä½†æœ‰æ—¶å¯¹å‰ç«¯æ¥è¯´ä¸å¤ªæ–¹ä¾¿ã€‚è¿™å°±æ˜¯æ˜ å°„å™¨å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ â€” å®ƒä»¬å°† DTO è½¬æ¢ä¸ºæ›´æ–¹ä¾¿çš„å½¢çŠ¶ã€‚

### åœ¨å“ªé‡Œæ”¾ç½® DTO

å¦‚æœæ‚¨åœ¨å•ç‹¬çš„åŒ…ä¸­æœ‰åç«¯ç±»å‹ï¼ˆä¾‹å¦‚ï¼Œå¦‚æœæ‚¨åœ¨å‰ç«¯å’Œåç«¯ä¹‹é—´å…±äº«ä»£ç ï¼‰ï¼Œé‚£ä¹ˆåªéœ€ä»é‚£é‡Œå¯¼å…¥æ‚¨çš„ DTO å°±å®Œæˆäº†ï¼å¦‚æœæ‚¨ä¸åœ¨åç«¯å’Œå‰ç«¯ä¹‹é—´å…±äº«ä»£ç ï¼Œé‚£ä¹ˆæ‚¨éœ€è¦å°† DTO ä¿å­˜åœ¨å‰ç«¯ä»£ç åº“çš„æŸä¸ªåœ°æ–¹ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢æ¢è®¨è¿™ç§æƒ…å†µã€‚

å¦‚æœæ‚¨çš„è¯·æ±‚å‡½æ•°åœ¨ `shared/api` ä¸­ï¼Œé‚£ä¹ˆ DTO åº”è¯¥æ”¾åœ¨é‚£é‡Œï¼Œå°±åœ¨ä½¿ç”¨å®ƒä»¬çš„å‡½æ•°æ—è¾¹ï¼š

```ts title="shared/api/songs.ts"
import type { ArtistDTO } from "./artists";

interface SongDTO {
  id: number;
  title: string;
  artist_ids: Array<ArtistDTO["id"]>;
}

export function listSongs() {
  return fetch('/api/songs').then((res) => res.json() as Promise<Array<SongDTO>>);
}
```

å¦‚å‰ä¸€èŠ‚æ‰€è¿°ï¼Œå°†è¯·æ±‚å’Œ DTO å­˜å‚¨åœ¨ Shared ä¸­çš„å¥½å¤„æ˜¯èƒ½å¤Ÿå¼•ç”¨å…¶ä»– DTOã€‚

### åœ¨å“ªé‡Œæ”¾ç½®æ˜ å°„å™¨

æ˜ å°„å™¨æ˜¯æ¥å— DTO è¿›è¡Œè½¬æ¢çš„å‡½æ•°ï¼Œå› æ­¤ï¼Œå®ƒä»¬åº”è¯¥ä½äº DTO å®šä¹‰é™„è¿‘ã€‚åœ¨å®è·µä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœæ‚¨çš„è¯·æ±‚å’Œ DTO åœ¨ `shared/api` ä¸­å®šä¹‰ï¼Œé‚£ä¹ˆæ˜ å°„å™¨ä¹Ÿåº”è¯¥æ”¾åœ¨é‚£é‡Œï¼š

```ts title="shared/api/songs.ts"
import type { ArtistDTO } from "./artists";

interface SongDTO {
  id: number;
  title: string;
  disc_no: number;
  artist_ids: Array<ArtistDTO["id"]>;
}

interface Song {
  id: string;
  title: string;
  /** The full title of the song, including the disc number. */
  fullTitle: string;
  artistIds: Array<string>;
}

function adaptSongDTO(dto: SongDTO): Song {
  return {
    id: String(dto.id),
    title: dto.title,
    fullTitle: `${dto.disc_no} / ${dto.title}`,
    artistIds: dto.artist_ids.map(String),
  };
}

export function listSongs() {
  return fetch('/api/songs').then(async (res) => (await res.json()).map(adaptSongDTO));
}
```

å¦‚æœæ‚¨çš„è¯·æ±‚å’Œå­˜å‚¨åœ¨å®ä½“ slices ä¸­å®šä¹‰ï¼Œé‚£ä¹ˆæ‰€æœ‰è¿™äº›ä»£ç éƒ½ä¼šæ”¾åœ¨é‚£é‡Œï¼Œè¯·è®°ä½ slices ä¹‹é—´äº¤å‰å¯¼å…¥çš„é™åˆ¶ï¼š

```ts title="entities/song/api/dto.ts"
import type { ArtistDTO } from "entities/artist/@x/song";

export interface SongDTO {
  id: number;
  title: string;
  disc_no: number;
  artist_ids: Array<ArtistDTO["id"]>;
}
```

```ts title="entities/song/api/mapper.ts"
import type { SongDTO } from "./dto";

export interface Song {
  id: string;
  title: string;
  /** The full title of the song, including the disc number. */
  fullTitle: string;
  artistIds: Array<string>;
}

export function adaptSongDTO(dto: SongDTO): Song {
  return {
    id: String(dto.id),
    title: dto.title,
    fullTitle: `${dto.disc_no} / ${dto.title}`,
    artistIds: dto.artist_ids.map(String),
  };
}
```

```ts title="entities/song/api/listSongs.ts"
import { adaptSongDTO } from "./mapper";

export function listSongs() {
  return fetch('/api/songs').then(async (res) => (await res.json()).map(adaptSongDTO));
}
```

```ts title="entities/song/model/songs.ts"
import { createSlice, createEntityAdapter } from "@reduxjs/toolkit";

import { listSongs } from "../api/listSongs";

export const fetchSongs = createAsyncThunk('songs/fetchSongs', listSongs);

const songAdapter = createEntityAdapter();
const songsSlice = createSlice({
  name: "songs",
  initialState: songAdapter.getInitialState(),
  reducers: {},
  extraReducers: (builder) => {
    builder.addCase(fetchSongs.fulfilled, (state, action) => {
      songAdapter.upsertMany(state, action.payload);
    })
  },
});
```

### å¦‚ä½•å¤„ç†åµŒå¥— DTO

æœ€æœ‰é—®é¢˜çš„éƒ¨åˆ†æ˜¯å½“æ¥è‡ªåç«¯çš„å“åº”åŒ…å«å¤šä¸ªå®ä½“æ—¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ­Œæ›²ä¸ä»…åŒ…å«ä½œè€…çš„ IDï¼Œè¿˜åŒ…å«æ•´ä¸ªä½œè€…å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ä½“ä¸å¯èƒ½ä¸ç›¸äº’äº†è§£ï¼ˆé™¤éæˆ‘ä»¬æƒ³è¦ä¸¢å¼ƒæ•°æ®æˆ–ä¸åç«¯å›¢é˜Ÿè¿›è¡Œåšå®šçš„å¯¹è¯ï¼‰ã€‚ä¸å…¶æƒ³å‡º slices ä¹‹é—´é—´æ¥è¿æ¥çš„è§£å†³æ–¹æ¡ˆï¼ˆä¾‹å¦‚å°†æ“ä½œåˆ†æ´¾åˆ°å…¶ä»– slices çš„é€šç”¨ä¸­é—´ä»¶ï¼‰ï¼Œä¸å¦‚ä½¿ç”¨ `@x` ç¬¦å·è¿›è¡Œæ˜¾å¼äº¤å‰å¯¼å…¥ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ Redux Toolkit å®ç°å®ƒï¼š

```ts title="entities/song/model/songs.ts"
import {
  createSlice,
  createEntityAdapter,
  createAsyncThunk,
  createSelector,
} from '@reduxjs/toolkit'
import { normalize, schema } from 'normalizr'

import { getSong } from "../api/getSong";

// å®šä¹‰ normalizr å®ä½“ schemas
export const artistEntity = new schema.Entity('artists')
export const songEntity = new schema.Entity('songs', {
  artists: [artistEntity],
})

const songAdapter = createEntityAdapter()

export const fetchSong = createAsyncThunk(
  'songs/fetchSong',
  async (id: string) => {
    const data = await getSong(id)
    // è§„èŒƒåŒ–æ•°æ®ï¼Œä»¥ä¾¿ reducers å¯ä»¥åŠ è½½å¯é¢„æµ‹çš„ payloadï¼Œå¦‚ï¼š
    // `action.payload = { songs: {}, artists: {} }`
    const normalized = normalize(data, songEntity)
    return normalized.entities
  }
)

export const slice = createSlice({
  name: 'songs',
  initialState: songAdapter.getInitialState(),
  reducers: {},
  extraReducers: (builder) => {
    builder.addCase(fetchSong.fulfilled, (state, action) => {
      songAdapter.upsertMany(state, action.payload.songs)
    })
  },
})

const reducer = slice.reducer
export default reducer
```

```ts title="entities/song/@x/artist.ts"
export { fetchSong } from "../model/songs";
```

```ts title="entities/artist/model/artists.ts"
import { createSlice, createEntityAdapter } from '@reduxjs/toolkit'

import { fetchSong } from 'entities/song/@x/artist'

const artistAdapter = createEntityAdapter()

export const slice = createSlice({
  name: 'users',
  initialState: artistAdapter.getInitialState(),
  reducers: {},
  extraReducers: (builder) => {
    builder.addCase(fetchSong.fulfilled, (state, action) => {
      // é€šè¿‡åœ¨è¿™é‡Œæ’å…¥è‰ºæœ¯å®¶æ¥å¤„ç†ç›¸åŒçš„è·å–ç»“æœ
      artistAdapter.upsertMany(state, action.payload.artists)
    })
  },
})

const reducer = slice.reducer
export default reducer
```

è¿™ç¨å¾®é™åˆ¶äº† slice éš”ç¦»çš„å¥½å¤„ï¼Œä½†å®ƒå‡†ç¡®åœ°è¡¨ç¤ºäº†æˆ‘ä»¬æ— æ³•æ§åˆ¶çš„è¿™ä¸¤ä¸ªå®ä½“ä¹‹é—´çš„è¿æ¥ã€‚å¦‚æœè¿™äº›å®ä½“è¦è¢«é‡æ„ï¼Œå®ƒä»¬å¿…é¡»ä¸€èµ·é‡æ„ã€‚

## å…¨å±€ç±»å‹å’Œ Redux

å…¨å±€ç±»å‹æ˜¯å°†åœ¨æ•´ä¸ªåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„ç±»å‹ã€‚æ ¹æ®å®ƒä»¬éœ€è¦äº†è§£çš„å†…å®¹ï¼Œæœ‰ä¸¤ç§å…¨å±€ç±»å‹ï¼š
1. æ²¡æœ‰ä»»ä½•åº”ç”¨ç¨‹åºç‰¹å®šå†…å®¹çš„é€šç”¨ç±»å‹
2. éœ€è¦äº†è§£æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ç±»å‹

ç¬¬ä¸€ç§æƒ…å†µå¾ˆå®¹æ˜“è§£å†³ â€” å°†æ‚¨çš„ç±»å‹æ”¾åœ¨ Shared ä¸­çš„é€‚å½“ segment ä¸­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰ä¸€ä¸ªç”¨äºåˆ†æçš„å…¨å±€å˜é‡æ¥å£ï¼Œæ‚¨å¯ä»¥å°†å…¶æ”¾åœ¨ `shared/analytics` ä¸­ã€‚

<Aside type="caution">

é¿å…åˆ›å»º `shared/types` æ–‡ä»¶å¤¹ã€‚å®ƒä»…åŸºäº"æ˜¯ä¸€ä¸ªç±»å‹"çš„å±æ€§å°†ä¸ç›¸å…³çš„äº‹ç‰©åˆ†ç»„ï¼Œè€Œè¯¥å±æ€§åœ¨é¡¹ç›®ä¸­æœç´¢ä»£ç æ—¶é€šå¸¸æ²¡æœ‰ç”¨ã€‚

</Aside>

ç¬¬äºŒç§æƒ…å†µåœ¨æ²¡æœ‰ RTK çš„ Redux é¡¹ç›®ä¸­å¾ˆå¸¸è§ã€‚æ‚¨çš„æœ€ç»ˆå­˜å‚¨ç±»å‹åªæœ‰åœ¨å°†æ‰€æœ‰ reducer æ·»åŠ åœ¨ä¸€èµ·åæ‰å¯ç”¨ï¼Œä½†æ­¤å­˜å‚¨ç±»å‹éœ€è¦å¯¹æ‚¨åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„é€‰æ‹©å™¨å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œè¿™æ˜¯æ‚¨çš„å…¸å‹å­˜å‚¨å®šä¹‰ï¼š

```ts title="app/store/index.ts"
import { combineReducers, rootReducer } from "redux";

import { songReducer } from "entities/song";
import { artistReducer } from "entities/artist";

const rootReducer = combineReducers(songReducer, artistReducer);

const store = createStore(rootReducer);

type RootState = ReturnType<typeof rootReducer>;
type AppDispatch = typeof store.dispatch;
```

åœ¨ `shared/store` ä¸­æ‹¥æœ‰ç±»å‹åŒ–çš„ Redux hooks `useAppDispatch` å’Œ `useAppSelector` ä¼šå¾ˆå¥½ï¼Œä½†ç”±äº[å±‚ä¸Šçš„å¯¼å…¥è§„åˆ™][import-rule-on-layers]ï¼Œå®ƒä»¬æ— æ³•ä» App å±‚å¯¼å…¥ `RootState` å’Œ `AppDispatch`ï¼š

> slice ä¸­çš„æ¨¡å—åªèƒ½åœ¨å…¶ä»– slices ä½äºä¸¥æ ¼è¾ƒä½çš„å±‚æ—¶å¯¼å…¥å®ƒä»¬ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ¨èçš„è§£å†³æ–¹æ¡ˆæ˜¯åœ¨ Shared å’Œ App å±‚ä¹‹é—´åˆ›å»ºéšå¼ä¾èµ–å…³ç³»ã€‚è¿™ä¸¤ç§ç±»å‹ `RootState` å’Œ `AppDispatch` ä¸å¤ªå¯èƒ½æ”¹å˜ï¼ŒRedux å¼€å‘è€…ä¼šç†Ÿæ‚‰å®ƒä»¬ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¿…å¤ªæ‹…å¿ƒå®ƒä»¬ã€‚

åœ¨ TypeScript ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡å°†ç±»å‹å£°æ˜ä¸ºå…¨å±€æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š

```ts title="app/store/index.ts"
/* ä¸ä¹‹å‰ä»£ç å—ä¸­çš„å†…å®¹ç›¸åŒâ€¦ */

declare type RootState = ReturnType<typeof rootReducer>;
declare type AppDispatch = typeof store.dispatch;
```

```ts title="shared/store/index.ts"
import { useDispatch, useSelector, type TypedUseSelectorHook } from "react-redux";

export const useAppDispatch = useDispatch.withTypes<AppDispatch>()
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;
```

## æšä¸¾

æšä¸¾çš„ä¸€èˆ¬è§„åˆ™æ˜¯å®ƒä»¬åº”è¯¥**å°½å¯èƒ½æ¥è¿‘ä½¿ç”¨ä½ç½®**å®šä¹‰ã€‚å½“æšä¸¾è¡¨ç¤ºç‰¹å®šäºå•ä¸ªåŠŸèƒ½çš„å€¼æ—¶ï¼Œå®ƒåº”è¯¥åœ¨åŒä¸€åŠŸèƒ½ä¸­å®šä¹‰ã€‚

segment çš„é€‰æ‹©ä¹Ÿåº”è¯¥ç”±ä½¿ç”¨ä½ç½®å†³å®šã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„æšä¸¾åŒ…å«å±å¹•ä¸Š toast çš„ä½ç½®ï¼Œå®ƒåº”è¯¥æ”¾åœ¨ `ui` segment ä¸­ã€‚å¦‚æœå®ƒè¡¨ç¤ºåç«¯æ“ä½œçš„åŠ è½½çŠ¶æ€ï¼Œå®ƒåº”è¯¥æ”¾åœ¨ `api` segment ä¸­ã€‚

ä¸€äº›æšä¸¾åœ¨æ•´ä¸ªé¡¹ç›®ä¸­ç¡®å®æ˜¯é€šç”¨çš„ï¼Œå¦‚ä¸€èˆ¬çš„åç«¯å“åº”çŠ¶æ€æˆ–è®¾è®¡ç³»ç»Ÿä»¤ç‰Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬æ”¾åœ¨ Shared ä¸­ï¼Œå¹¶æ ¹æ®æšä¸¾æ‰€ä»£è¡¨çš„å†…å®¹é€‰æ‹© segmentï¼ˆå“åº”çŠ¶æ€ç”¨ `api`ï¼Œè®¾è®¡ä»¤ç‰Œç”¨ `ui` ç­‰ï¼‰ã€‚

## ç±»å‹éªŒè¯ schemas å’Œ Zod \{#type-validation-schemas-and-zod}

å¦‚æœæ‚¨æƒ³éªŒè¯æ‚¨çš„æ•°æ®ç¬¦åˆæŸç§å½¢çŠ¶æˆ–çº¦æŸï¼Œæ‚¨å¯ä»¥å®šä¹‰ä¸€ä¸ªéªŒè¯ schemaã€‚åœ¨ TypeScript ä¸­ï¼Œè¿™é¡¹å·¥ä½œçš„æµè¡Œåº“æ˜¯ [Zod][ext-zod]ã€‚éªŒè¯ schemas ä¹Ÿåº”è¯¥å°½å¯èƒ½ä¸ä½¿ç”¨å®ƒä»¬çš„ä»£ç æ”¾åœ¨ä¸€èµ·ã€‚

éªŒè¯ schemas ç±»ä¼¼äºæ˜ å°„å™¨ï¼ˆå¦‚[æ•°æ®ä¼ è¾“å¯¹è±¡å’Œæ˜ å°„å™¨](#data-transfer-objects-and-mappers)éƒ¨åˆ†æ‰€è®¨è®ºçš„ï¼‰ï¼Œå®ƒä»¬æ¥å—æ•°æ®ä¼ è¾“å¯¹è±¡å¹¶è§£æå®ƒï¼Œå¦‚æœè§£æå¤±è´¥åˆ™äº§ç”Ÿé”™è¯¯ã€‚

éªŒè¯æœ€å¸¸è§çš„æƒ…å†µä¹‹ä¸€æ˜¯æ¥è‡ªåç«¯çš„æ•°æ®ã€‚é€šå¸¸ï¼Œå½“æ•°æ®ä¸ schema ä¸åŒ¹é…æ—¶ï¼Œæ‚¨å¸Œæœ›è¯·æ±‚å¤±è´¥ï¼Œå› æ­¤å°† schema æ”¾åœ¨ä¸è¯·æ±‚å‡½æ•°ç›¸åŒçš„ä½ç½®æ˜¯æœ‰æ„ä¹‰çš„ï¼Œè¿™é€šå¸¸æ˜¯ `api` segmentã€‚

å¦‚æœæ‚¨çš„æ•°æ®é€šè¿‡ç”¨æˆ·è¾“å…¥ï¼ˆå¦‚è¡¨å•ï¼‰ä¼ å…¥ï¼ŒéªŒè¯åº”è¯¥åœ¨è¾“å…¥æ•°æ®æ—¶è¿›è¡Œã€‚æ‚¨å¯ä»¥å°† schema æ”¾åœ¨ `ui` segment ä¸­ï¼Œç´§æŒ¨ç€è¡¨å•ç»„ä»¶ï¼Œæˆ–è€…å¦‚æœ `ui` segment å¤ªæ‹¥æŒ¤ï¼Œå¯ä»¥æ”¾åœ¨ `model` segment ä¸­ã€‚

## ç»„ä»¶ props å’Œ context çš„ç±»å‹å®šä¹‰

ä¸€èˆ¬æ¥è¯´ï¼Œæœ€å¥½å°† props æˆ– context æ¥å£ä¿å­˜åœ¨ä½¿ç”¨å®ƒä»¬çš„ç»„ä»¶æˆ– context çš„åŒä¸€æ–‡ä»¶ä¸­ã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå•æ–‡ä»¶ç»„ä»¶çš„æ¡†æ¶ï¼Œå¦‚ Vue æˆ– Svelteï¼Œå¹¶ä¸”æ‚¨æ— æ³•åœ¨åŒä¸€æ–‡ä»¶ä¸­å®šä¹‰ props æ¥å£ï¼Œæˆ–è€…æ‚¨æƒ³åœ¨å‡ ä¸ªç»„ä»¶ä¹‹é—´å…±äº«è¯¥æ¥å£ï¼Œè¯·åœ¨åŒä¸€æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œé€šå¸¸æ˜¯ `ui` segmentã€‚

ä»¥ä¸‹æ˜¯ JSXï¼ˆReact æˆ– Solidï¼‰çš„ç¤ºä¾‹ï¼š

```ts title="pages/home/ui/RecentActions.tsx"
interface RecentActionsProps {
  actions: Array<{ id: string; text: string }>;
}

export function RecentActions({ actions }: RecentActionsProps) {
  /* â€¦ */
}
```

ä»¥ä¸‹æ˜¯å°†æ¥å£å­˜å‚¨åœ¨ Vue çš„å•ç‹¬æ–‡ä»¶ä¸­çš„ç¤ºä¾‹ï¼š

```ts title="pages/home/ui/RecentActionsProps.ts"
export interface RecentActionsProps {
  actions: Array<{ id: string; text: string }>;
}
```

```html title="pages/home/ui/RecentActions.vue"
<script setup lang="ts">
  import type { RecentActionsProps } from "./RecentActionsProps";

  const props = defineProps<RecentActionsProps>();
</script>
```

## ç¯å¢ƒå£°æ˜æ–‡ä»¶ (`*.d.ts`)

ä¸€äº›åŒ…ï¼Œä¾‹å¦‚ [Vite][ext-vite] æˆ– [ts-reset][ext-ts-reset]ï¼Œéœ€è¦ç¯å¢ƒå£°æ˜æ–‡ä»¶æ‰èƒ½åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºä¸­å·¥ä½œã€‚é€šå¸¸ï¼Œå®ƒä»¬ä¸å¤§ä¹Ÿä¸å¤æ‚ï¼Œæ‰€ä»¥å®ƒä»¬é€šå¸¸ä¸éœ€è¦ä»»ä½•æ¶æ„ï¼Œåªéœ€å°†å®ƒä»¬æ”¾åœ¨ `src/` æ–‡ä»¶å¤¹ä¸­å³å¯ã€‚ä¸ºäº†ä¿æŒ `src` æ›´æœ‰ç»„ç»‡ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬ä¿å­˜åœ¨ App å±‚çš„ `app/ambient/` ä¸­ã€‚

å…¶ä»–åŒ…æ ¹æœ¬æ²¡æœ‰ç±»å‹å®šä¹‰ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†å®ƒä»¬å£°æ˜ä¸ºæ— ç±»å‹æˆ–ç”šè‡³ä¸ºå®ƒä»¬ç¼–å†™è‡ªå·±çš„ç±»å‹å®šä¹‰ã€‚è¿™äº›ç±»å‹å®šä¹‰çš„å¥½åœ°æ–¹æ˜¯ `shared/lib`ï¼Œåœ¨åƒ `shared/lib/untyped-packages` è¿™æ ·çš„æ–‡ä»¶å¤¹ä¸­ã€‚åœ¨é‚£é‡Œåˆ›å»ºä¸€ä¸ª `%LIBRARY_NAME%.d.ts` æ–‡ä»¶å¹¶å£°æ˜æ‚¨éœ€è¦çš„ç±»å‹ï¼š

```ts title="shared/lib/untyped-packages/use-react-screenshot.d.ts"
// è¿™ä¸ªåº“æ²¡æœ‰ç±»å‹å®šä¹‰ï¼Œæˆ‘ä»¬ä¸æƒ³è´¹å¿ƒç¼–å†™è‡ªå·±çš„ã€‚
declare module "use-react-screenshot";
```

## ç±»å‹çš„è‡ªåŠ¨ç”Ÿæˆ

ä»å¤–éƒ¨æºç”Ÿæˆç±»å‹æ˜¯å¾ˆå¸¸è§çš„ï¼Œä¾‹å¦‚ï¼Œä» OpenAPI schema ç”Ÿæˆåç«¯ç±»å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸ºè¿™äº›ç±»å‹åœ¨æ‚¨çš„ä»£ç åº“ä¸­åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„ä½ç½®ï¼Œå¦‚ `shared/api/openapi`ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œæ‚¨è¿˜åº”è¯¥åœ¨è¯¥æ–‡ä»¶å¤¹ä¸­åŒ…å«ä¸€ä¸ª READMEï¼Œæè¿°è¿™äº›æ–‡ä»¶æ˜¯ä»€ä¹ˆã€å¦‚ä½•é‡æ–°ç”Ÿæˆå®ƒä»¬ç­‰ã€‚

[import-rule-on-layers]: /zh/docs/reference/layers#import-rule-on-layers
[ext-type-fest]: https://github.com/sindresorhus/type-fest
[ext-zod]: https://zod.dev
[ext-vite]: https://vitejs.dev
[ext-ts-reset]: https://www.totaltypescript.com/ts-reset
